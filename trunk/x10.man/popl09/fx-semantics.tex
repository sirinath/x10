
\begin{figure*}
\footnotesize
\begin{tabular}{l}
\begin{tabular}{ll}
\multicolumn{2}{l}{\bf \FX{} productions:} \\
\quad\\
\begin{tabular}{r@{\quad}rcl}
  (Class) & {\tt L} &{::=}& \klass\ {\tt C}($\bar{\tt f}:\bar{\tt V}$)\{{\tt c}\}\ {\tt extends}\ {\tt N}\ \{$\bar{\tt M}$\} \\
  (Method)& {\tt M} &{::=}& {\tt def}\ {\tt m}($\bar{\tt x}:\bar{\tt V}$){\tt \{c\}:V=e;}\\
  (Exp.)& {\tt e} &{::=}& \tt {\tt x} \alt \this \alt {\tt e.f} \alt {\tt e.m}($\bar{\tt e}$) \\
  &&& \alt \new\ C($\bar{\tt e}$) \alt {\tt e}\ \mbox{as {\tt T}} \\ 
  (Par Type) & {\tt U},{\tt V}&{::=} & {\tt T} \\
\end{tabular} 
&
\begin{tabular}{r@{\quad}rcl}
  (Type)& {\tt S},{\tt T}&{::=}& {\tt N} \alt {\tt T\{c\}} \alt ({\tt x}:S;T)\\
  (N Type) & {\tt N}&{::=}& {\tt C} \alt {\tt N\{c\}}\\
  (C Term) & {\tt t} &{::=}& {\tt x}\alt \self \alt \this \alt {\tt t}.f \alt \new\ {\tt C}($\bar{t}$)\\
  (Const.) & {\tt c},{\tt d} &{::=}&\true \alt {\tt t==t} \alt {\tt c},{\tt c} \alt {\tt x}:{\tt V};{\tt c}\\
%  (Values) & {\tt v}&{::=}& \new\ {\tt C}($\bar{\tt v}$)
\end{tabular} 
\end{tabular}
\quad \\
{\tabcolsep=0pt
\begin{tabular}{p{0.25\textwidth}p{0.25\textwidth}p{0.25\textwidth}p{0.25\textwidth}}
\multicolumn{4}{l}{\bf \FX{} well-formedness rules:}\\
\infax[{\tt true}]{\Gamma \vdash {\tt true}: {\tt o}}
&
\infrule[And]
	{\tt \Gamma \vdash c_0: o \andalso \Gamma \vdash c_1: o}
	{\tt \Gamma \vdash (c_0,c_1):o}
&
\infrule[Exists]
	{\tt \Gamma \vdash t: T \andalso \Gamma \vdash c[t/x]:o}
	{\tt \Gamma \vdash x:T;c: o}
&
\infrule[Class]
	{\Gamma \vdash \klass({\tt C})}
	{\Gamma \vdash {\tt C}\ \type} 
\\
\infrule[Exist-T]
	{\tt \Gamma \vdash {\tt S}\ \type, {\tt T}\ \type}
	{\tt \Gamma \vdash {\tt x:S;T}\ {\tt type}} 
&
\infrule[Dep]
	{\tt \Gamma \vdash T\ \type \andalso \Gamma, \self:T \vdash c:o}
	{\tt \Gamma \vdash T\{c\}\ {\tt type}} 
\end{tabular}}
\quad\\
\quad\\
{\tabcolsep=0pt
\begin{tabular}{l}
\begin{tabular}{p{0.25\textwidth}p{0.25\textwidth}p{0.47\textwidth}}
\multicolumn{3}{l}{\bf Type judgement rules:}\\
\infax[T-Var]
      {\Gamma, {\tt x}:{\tt T} \vdash {\tt x}:{\tt T\{\self==x\}}}
&
\infrule[T-Cast]
	{\Gamma \vdash {\tt e}:{\tt U} \andalso \Gamma \vdash {\tt T} \ \type}
	{\Gamma \vdash {\tt e}\ \as\ {\tt T}: {\tt T}} &
\infrule[T-Field]
	{\Gamma \vdash {\tt e}: {\tt S} \andalso \Gamma,{\tt z}:{\tt S}\vdash {\tt z}\ \has\ {\tt f}:{\tt V} \andalso \mbox{({\tt z} fresh)} }
	{\Gamma \vdash {\tt e}.{\tt f}:  ({\tt z}:{\tt S};{\tt V\{\self=z.f\}})}
\end{tabular}\\
\begin{tabular}{p{0.50\textwidth}p{0.47\textwidth}} 
\infrule[T-INVK]
	{\Gamma \vdash {\tt e}:{\tt T},\bar{\tt e}:\bar{\tt V} \andalso \\
	  \Gamma,{\tt v}:{\tt T},\bar{\tt v}:\bar{\tt V} \vdash
		{\tt v}\ \has\ ({\tt m}(\bar{\tt v}:\bar{\tt U}), {\tt c} \rightarrow {\tt S}), 
		\bar{\tt V} \subtype \bar{\tt U},{\tt c} 
	  \andalso \mbox{({\tt v},$\bar{\tt v}$ fresh)}}
	{\Gamma \vdash {\tt e}.{\tt m}(\bar{\tt e}): ({\tt v}:{\tt T};\bar{\tt v}:\bar{\tt V};S)}
	&
\infrule[T-NEW]
	{\Gamma \vdash \bar{\tt e}:\bar{\tt T} \andalso \vdash \klass({\tt C}) \\ 
	  \Gamma,{\tt v}:{\tt C}\vdash \fields({\tt v})=\bar{\tt f}:\bar{\tt V}  \andalso \mbox{({\tt v},$\bar{\tt v}$\ fresh)}\\
	  \Gamma, {\tt v}:{\tt C}, \bar{\tt v}:\bar{\tt T}, {\tt v}.\bar{\tt f}=\bar{\tt v} 
	  \vdash \bar{\tt T} \subtype \bar{\tt V}, \inv({\tt C},{\tt v})}
	{\Gamma \vdash \new\ {\tt C}(\bar{\tt e}): {\tt C}\{\bar{\tt v}:\bar{\tt T}; \new\ {\tt C}(\bar{\tt v})=\self, \inv({\tt C},\self)\}}\\
\infrule[Method OK]
	{\this:{\tt C}\vdash {\tt c}:o \andalso \this:{\tt C},\bar{\tt x}:\bar{\tt V},{\tt c} \vdash {\tt T} \ \type, \bar{\tt V} \ \type, 
	  {\tt e}:{\tt S}, {\tt S} \subtype {\tt T}}
	{{\tt def}\ {\tt m}(\bar{\tt x}:\bar{\tt V})\{{\tt c}\}:{\tt T}= {\tt e};\ \mbox{OK in}\ C}
	&
\infrule[Class OK]
	{\bar{\tt M}\ \mbox{OK in}\ {\tt C}\andalso \this:{\tt C}\vdash {\tt c}:o \andalso \this:{\tt C},{\tt c} \vdash \bar{\tt V}\ \type, {\tt N}\ \type}
	{\mbox{\tt class}\ {\tt C}(\bar{\tt f}:\bar{\tt V})\{{\tt c}\}\ 
	  \mbox{\tt extends}\ {\tt N}\{\bar{\tt M}\} \ \mbox{OK}}
\end{tabular}
\end{tabular}}\\
\quad\\
\begin{tabular}{p{0.43\textwidth}@{\quad}p{0.54\textwidth}}
\multicolumn{2}{l}{\bf Transition Rules:}\\
\typicallabel{RC-Field}
\infrule[\RField]
	{\tt x:C \vdash \fields(\tt x)=\bar{\tt f}:\bar{\tt V}}
	{(\new\ {\tt C}(\bar{\tt e})).{\tt f_i} \derives {\tt e_i}}

\infrule[\RCField]%
	{{\tt e} \derives {{\tt e}}'}
	{{\tt e}.{\tt f}_i \derives {{\tt e}}'.{\tt f}_i}

\infrule[\RCast]%
	{\vdash {\tt C}\{\self==\new\ C(\bar{\tt d})\} \subtype {\tt T}}
	{{\tt (T)(\new\ C(\bar{\tt d}))} \derives \new\ C(\bar{\tt d})}

\infrule[\RCCast]%
	{{\tt e} \derives {{\tt e}}'}
	{{\tt (T) e} \derives {{\tt (T) e}}'}
	&
	\typicallabel{R-Invk-Recv}
	\infrule[\RInvk]
		{{\tt x:C}\vdash {\tt x}\ \has\ {\tt m}(\bar{\tt x}:\bar{\tt T}){\tt \{c\}:T=e}}
		{(\new\ {\tt C}(\bar{\tt e})).{\tt m}(\bar{\tt d}) \derives {\tt e[\new\ {\tt C}(\bar{\tt e}),\bar{\tt d}/\this,\bar{\tt x}]}}

	\infrule[\RCInvkRecv]%
		{{\tt e} \derives {{\tt e}}'}
		{{\tt e}.{\tt m}(\bar{\tt e}) \derives {{\tt e}}'.{\tt m}(\bar{\tt e})}

	\infrule[\RCInvkArg]%
		{{\tt e}_i \derives {{\tt e}_i}'}
		{{\tt e}.{\tt m}(\ldots,{\tt e}_i,\ldots) \derives {{\tt e}}.{\tt m}(\ldots,{\tt e}_i',\ldots)} 

	\infrule[\RCNewArg]%
		{{\tt e}_i \derives {{\tt e}_i}'}
		{\new\ {\tt C}(\ldots,{\tt e}_i,\ldots) \derives \new\ {\tt C}(\ldots,{\tt e}_i',\ldots)}
\end{tabular}
\end{tabular}  
 \caption{Semantics of \FX}\label{fig:FX}
\end{figure*}
