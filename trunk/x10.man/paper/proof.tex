Here we prove a soundness theorem for \CFJ{}.  

\begin{lemma}[Substitution Lemma]
\label{substitution}
The following is a derived rule:
\infrule[Subst]
{\Gamma \vdash \bar{\tt d}:\bar{\tt U} \andalso \Gamma, \bar{\tt
x}:\bar{\tt U} \vdash \bar{\tt U}\subtype\bar{\tt V} \andalso
\Gamma, \bar{\tt x}:\bar{\tt V} \vdash {\tt e:T}}
{\Gamma \vdash {\tt e[\bar{\tt d}/\bar{\tt x}]:S}, {\tt S
\subtype \bar{\tt x}:\bar{\tt V};T}}
\end{lemma}

\begin{proof}
Straightforward.
\end{proof}

\eat{
\begin{proof}
Assume the premises.  The proof is by structural induction on
{\tt e}.

\begin{itemize}
\item \xcd{x}.
Then $\Gamma, \xcd{x}_i \ty \xcd{V}_i \vdash {\tt T}$.
There are two subcases.

\begin{itemize}
\item
If \xcd{x} is \xcd{x$_i$}, then 
${\tt e[\bar{\tt d}/\bar{\tt x}]}$ = \xcd{d$_i$}.
$\Gamma \vdash {\tt d}_i \ty {\tt U}_i$.

$\Gamma \vdash {\tt U}_i \subtype {\tt x}_i \ty {\tt V}_i; {\tt T}$
follows from \rn{S-Exists-R}.

and
$\Gamma \vdash {\tt U}_i \subtype {\tt T}[{\tt d}_i/{\tt x}_i]$

Since,
$\Gamma \vdash {\tt d}_i \ty {\tt U}_i$
by \rn{T-sub} we have
$\Gamma \vdash {\tt d}_i \ty {\tt V}_i$.

\item
Otherwise, 
${\tt e[\bar{\tt d}/\bar{\tt x}] = e}$
and the case
follows from \rn{S-Exists-R}.
\end{itemize}

\item $\xcd{e}.\xcd{f}$
\item $\xcd{e}.\xcd{m}(\tbar{e})$
\item $\xcd{new}~\xcd{C}(\tbar{e})$
\item $\xcd{e}~\xcd{as}~\xcd{T}$
\end{itemize}
\end{proof}
}

% Unchanged from FJ
\begin{lemma}[Weakening]
\label{weakening}
If $\Gamma \vdash {\tt e} \ty {\tt T}$, then
$\Gamma, {\tt x} \ty {\tt S} \vdash {\tt e} \ty {\tt T}$.
\end{lemma}

\begin{proof}
Straightforward.
\end{proof}

\eat{
% Unchanged from FJ
\begin{lemma}[Body type]
\label{body-type}
If $\mtype(C(:d),{\tt m},z_0)=\bar{\tt T}\ \bar{\tt x} : {\tt c}
\rightarrow {\tt S}$, and $mbody({\tt m}, C)=\bar{\tt x}.{\tt e}$, 
then there exists ${\tt U}, {\tt V}$ such that
$C \subtype {\tt U}$, ${\tt V}\subtype {\tt S}$, and
$\bar{\tt T}\ \bar{\tt x},{\tt U}\ \this \vdash {\tt V}\ {\tt e}$.
\end{lemma}

\begin{proof}
Straightforward.
\end{proof}
}

\eat{
\subsection{Erasure}

Constrained types in \CFJ{} are a form of {\em refinement
type}~\cite{refinement-types}.  If constraints are erased from a
well-typed program,
the resulting program will behave identically to the original unerased
program except that the original program might be unable to take
a step on a cast.

Let $\Lb {\tt e} \Rb$ be the erasure of ${\tt e}$ defined as follows:
\begin{align*}
\Lb {\tt x} \Rb &= {\tt x} \\
\Lb {\tt e}.{\tt f} \Rb &= \Lb {\tt e} \Rb.{\tt f} \\
\Lb {\tt e}.{\tt m}(\bar{\tt e}) \Rb &= \Lb {\tt e} \Rb.{\tt m}(\bar{\Lb {\tt e} \Rb}) \\
\Lb {\tt new}~{\tt C}(\bar{\tt e}) \Rb &= {\tt new}~{\tt C}(\bar{\Lb {\tt e} \Rb}) \\
\Lb {\tt e}~{\tt as}~{\tt C}\{{\tt c}\} \Rb &=
\Lb {\tt e} \Rb~{\tt as}~{\tt C}
\end{align*}

\begin{theorem}[Erasure]

If $\vdash {\tt C}(:{\tt c})\ {\tt e}$ and ${\tt e} \starderives {\tt v}$,
then $\vdash {\tt C}\ \Lb {\tt e} \Rb$ and $\Lb
{\tt e} \Rb \starderives \Lb {\tt v} \Rb$.

\end{theorem}
}

\eat{
\begin{lemma}
\label{subtyping}
We have $\Gamma \vdash T \subtype T$.
If $\Gamma \vdash T_1 \subtype T_2$ and $\Gamma \vdash T_2 \subtype T_3$,
then $\Gamma \vdash T_1 \subtype T_3$.
\end{lemma}

\begin{proof}
Straightforward.
\end{proof}
}

\begin{lemma}
\label{lemmaone} % 1. 
If   $\Gamma \vdash S \subtype T$,
then $\fields(S,z)$ has $\fields(T,z)$ as a prefix.
\end{lemma}

\begin{proof}
Immediate from the definition of $\fields$.
\end{proof}

\begin{lemma}
\label{lemmatwo} % 2. 
If   $S \subtype T$,
then $\mtype(S,m,z) = \mtype(T,m,z)$.
\end{lemma}

\begin{proof}
Immediate from the definition of $\mtype$.
\end{proof}

\begin{lemma}
\label{existential-subtyping}
If   $\Gamma \vdash S \subtype T$,
then $$(z:S;~c_0)[x/\self] \vdash_{\cal C} (z:T;~c_0)[x/\self]$$
where $x$ is fresh.
\end{lemma}

\begin{proof}
Straightforward.
\end{proof}

\begin{lemma}
\label{lemmafour} % 4. 
If   $\Gamma \vdash S \subtype T$,
and  $\sigma(\Gamma,{\tt f}: {\tt T}) \vdash_{\cal C} c_0$,
then $\sigma(\Gamma,{\tt f}: {\tt S}) \vdash_{\cal C} c_0$,
\end{lemma}

\begin{proof}
From $\Gamma \vdash S \subtype T$,
we must have $S = C\{c\}$ and $T = D\{d\}$
where
$C \subtype D$
and
$\sigma(\Gamma, x: C\{c\}) \vdash_{\cal C} d[x/\self]$
with $x$ fresh.
From the definition of $\sigma(\cdot)$ we have
    $$\sigma(\Gamma,{\tt f}: {\tt S}) = \sigma(\Gamma), c[f/\self], \inv(C,f)$$ and $$\sigma(\Gamma,{\tt f}: {\tt T}) = \sigma(\Gamma), d[f/\self], \inv(D,f).$$
From $\Gamma \vdash S \subtype T$ we have 
$\sigma(\Gamma, x: C\{c\}) \vdash_{\cal C} d[f/\self]$.
Additionally, from the definition of $\inv(C,f)$ and
from $C \subtype D$, 
we have that $\inv(C,f)$ is a constraint that has $\inv(D,f)$ as a conjunct so 
$\inv(C,f) \vdash_{\cal C} \inv(D,f)$.
We conclude
$\sigma(\Gamma,{\tt f}: {\tt S}) \vdash_{\cal C}
\sigma(\Gamma,{\tt f}: {\tt T}).$
We have that $\vdash_{\cal C}$ is transitive so 
from $\sigma(\Gamma,{\tt f}: {\tt S}) \vdash_{\cal C}
\sigma(\Gamma,{\tt f}: {\tt T})$
and
$\sigma(\Gamma,{\tt f}: {\tt T}) \vdash_{\cal C} c_0$,
we have 
$\sigma(\Gamma,{\tt f}: {\tt S}) \vdash_{\cal C} c_0$.
\end{proof}

\begin{lemma}
\label{lemmathree} % 3. 
if   $\Gamma, {\tt f}: {\tt T} \vdash U \subtype U'$,
and  $\Gamma \vdash S \subtype T$,
then $\Gamma, {\tt f}: {\tt S} \vdash U \subtype U'$.
\end{lemma}

\begin{proof}
From $\Gamma, {\tt f}: {\tt T} \vdash U \subtype U'$
we must have $U = C\{c\}$ and $U' = D\{d\}$
where
$C \subtype D$
and 
$$\sigma(\Gamma, {\tt f}: {\tt T}, x: C\{c\}) \vdash_{\cal C} d[x/\self]$$
with $x$ fresh.
From Lemma~\ref{lemmafour},
$\Gamma \vdash S \subtype T$,
and
$$\sigma(\Gamma, {\tt f}: {\tt T}, x: C\{c\}) \vdash_{\cal C} d[x/\self],$$
we have
$$\sigma(\Gamma, {\tt f}: {\tt S}, x: C\{c\}) \vdash_{\cal C} d[x/\self].$$
So we can use 
$C \subtype D$
and
$$\sigma(\Gamma, {\tt f}: {\tt S}, x: C\{c\}) \vdash_{\cal C} d[x/\self]$$
to derive 
$\Gamma, {\tt f}: {\tt S} \vdash U \subtype U'$.
\end{proof}

\begin{lemma}
\label{lemmafive} % 5. 
if   $\Gamma \vdash S \subtype T$,
then $\Gamma \vdash E\{z: S; c_0\} \subtype E\{z: T; c_0\}$.
\end{lemma}

\begin{proof}
To prove the desired conclusion $E\{z: S; c_0\} \subtype E\{z: T; c_0\}$ 
we need to show that
$$\sigma(\Gamma, x: E\{z: S; c_0)\}) \vdash_{\cal C} (z: T; c_0)[x/\self].$$
%
We have 
$$\sigma(\Gamma, x: E\{z: S; c_0\}) = 
 \sigma(\Gamma), (z: S; c_0)[x/\self], \inv(E,x).$$
From Lemma~\ref{existential-subtyping} and
$\Gamma \vdash S \subtype T$, 
we have
$$(z:S; c_0)[x/\self] \vdash_{\cal C} (z:T; c_0)[x/\self].$$
From $$\sigma(\Gamma, x: E\{z: S; c_0\}) =
 \sigma(\Gamma), (z: S; c_0)[x/\self], inv(E,x)$$
and
$$(z:S; c_0)[x/\self] \vdash_{\cal C} (z:T; c_0)[x/\self],$$
we conclude 
$$\sigma(\Gamma, x: E\{z: S; c_0\}) \vdash_{\cal C} (z: T; c_0)[x/\self].$$
\end{proof}

% \begin{lemma}
% \label{lemmasix} % 6. 
% If $\Gamma \vdash \bar{\tt U}\ \bar{\tt d}$,
% $\theta = [\bar{\tt f} / \this.\bar{\tt f}]$,
% $\fields(C,\theta) = \bar{\tt Z} \bar{\tt f}$,
% $\Gamma, \bar{\tt U}\ \bar{\tt f} \vdash \bar{\tt U} \subtype \bar{\tt Z}$,
% $\sigma(\Gamma, \bar{\tt U}\ \bar{\tt f}) \vdash_{\cal C} inv(C,\theta)$,
% $\vdash C \subtype T[new C(\bar{\tt d}) / \self]$,
% then $\Gamma \vdash C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = 
%      \bar{\tt f}) \subtype T$.
% \end{lemma}
% 
% \begin{proof}
% (Notes)
% It is reasonable to assume that the constraint system {\cal C} satisfies the
% property that if $\bar{\tt d} = \bar{\tt e}$ (where $\bar{\tt d}$ and $\bar{\tt e}$ 
% are sequence of values) 
% then
% for any sequence of constraints $\bar{\tt c}$, $\bar{\tt c}[\bar{\tt d}/\self]$ and 
% $\bar{\tt c} [\bar{\tt e}/\self]$
% are equi-satisfiable, i.e., one holds iff the other holds. 
% (Here by $\bar{\tt c} [\bar{\tt d}/\self]$ we mean $c_1[d1/\self], \ldots, c_n[dn/\self]$.)
% 
% Now when proving subject reduction for this case we take the type $S$ to be 
% $C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f}, \self=o)$.
% Note the addition of the $\self=o$ clause. 
% Note also that from
% 
% $\Gamma \vdash C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f}) o$
% 
% we can derive
% 
% $\Gamma \vdash C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f}, \self=o) o$
% 
% This of course makes complete sense ... all we need to show is that {\em this
% particular object} $o$ is of the type that it has been cast to.
% 
% But we have just checked this condition, i.e. 
% $type(o) \subtype D and \vdash_{\cal C} d[o/\self]$. 
% So we are done.
% 
% Note about the proof:
% the trick of adding $\self=o$ is critical. There is no hope of showing
% that $C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f}) \subtype D(:d)$. 
% All we have checked is the one case that {\em this one object\/} $o$ 
% satisfies the condition $d$, not that *all* objects 
% that satisfy $C(: \bar{\tt U}\ \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f})$ 
% also satisfy $D(:d)$. 
% So we take advantage of our ability to choose the type $S$ for $o$ 
% to get this done.
%\end{proof}

% \begin{lemma}
% \label{lemmaseven} % 7. 
% If   $\Gamma, \bar{\tt T} \bar{\tt f} \vdash \bar{\tt T} \subtype \bar{\tt Z}$
% and  $\theta = [\bar{\tt f} / \this.\bar{\tt f}]$,
% and  $\fields(C,\theta) = \bar{\tt Z} \bar{\tt f}$,
% and  $\fields(T_0,z_0) = \bar{\tt U}\ \bar{\tt f}$,
% and  $T_0 equiv C(\bar{\tt T} \bar{\tt f}; \self.\bar{\tt f} = \bar{\tt f})$,
% then $\Gamma \vdash T_i \subtype (T_0 z_0; z_0.f_i = \self; U_i)$
% \end{lemma}
% 
% \begin{proof}
% From these we can conclude
%    $\Gamma \vdash T_0 new C(bar e)$
% where $T_0$ is $C(: \bar{\tt T} \bar{\tt p}; \self.\bar{\tt f} = \bar{\tt p})$.
% 
% Now the case we are concerned about is $new C(\bar{\tt e}).f_i --> e_i$.
% 
% We want to show that the static type of $e_i$, namely $T_i$, 
% is a subtype of the static
% type of $new C(\bar{\tt e}).f_i$, which is
% $(T_0 z_0; z_0.f_i=\self, V_i[z_0.\bar{\tt f}/\this.\bar{\tt f}])$
% 
% Let $x$ be an arbitrary element of $T_i$. 
% We wish to show that $x$ is an element of
% the type $(T_0 z_0; z_0.f_i=\self, V_i[z_0.\bar{\tt f}/\this.\bar{\tt f}])$.
% To do this we have
% to show that it is possible to construct from $x$ an object $z_0$ of type 
% $T_0$ such
% that $x$ is the $f_i$'th field of $z_0$. But this is given to us by (4).
% Let $\bar{\tt t}$ be
% a set of values of type $bar T$, with $x$ chosen at index $i$.
% Then per (4), $T_i$ is a
% subtype of $V_i[\bar{\tt t}/\this.\bar{\tt f}]$. Since $x$ is a value of the type $T_i$, 
% it is a value of the type $V_i[\bar{\tt t}/\this.\bar{\tt f}]$. 
% Therefore we have constructed the object $z_0$ 
% which is required to show that $x$ is an element of 
% $(T_0 z_0; z_0.f_i=\self, V_i[z_0.\bar{\tt f}/\this.\bar{\tt f}])$.
% 
% I have implicitly used here the following genericity property of constraint
% systems (see Vijay Saraswat's LICS 91 paper):
% If $\Gamma \vdash A$ then $\Gamma[\bar{\tt t}/\bar{\tt y}] \vdash A [\bar{\tt t}/\bar{\tt y}]$.
% That is the set of axioms of the constraint system may contain free
% variables but are assumed to be closed under instantiation.
% \end{proof}


\begin{theorem}[Subject Reduction] 
\label{preservation}
If $\Gamma \vdash e: T$ and $e \derives e'$, then for some type $S$,
$\Gamma \vdash e': S$ and $\Gamma \vdash S \subtype T$.
\end{theorem}

\begin{proof}
We proceed by induction on the
structure of the derivation of $\Gamma \vdash e: T$.  We now have five
cases depending on the last rule used in the derivation
of $\Gamma \vdash e: T$.
\begin{itemize}
\item
\TVar: The expression cannot take a step, so the conclusion is immediate.
\item
\TCast: We have two subcases.
   \begin{itemize}
   \item
   \RCast:  For the expression {\tt o~as~T}, where 
            ${\tt o} = {\tt \new\ {\tt C(\bar{\tt d})}}$,
            we have from \TCast\ that 
            $$\Gamma \vdash {\tt o: C\{\bar{\tt f}: \bar{U}
                {\tt ;\self.\bar{f}}=\bar{\tt f}\}}.$$
            Additionally, we have from \RCast\ that 
            $\vdash C \subtype T[o/\self]$.
            We now choose 
            $$S = {\tt C\{\bar{\tt f}: \bar{U}
                {\tt ;\self.\bar{f}}=\bar{\tt f}; \self=o\}}.$$
            From 
            $$\Gamma \vdash {\tt o: C\{\bar{\tt f}: \bar{U}
                {\tt ;\self.\bar{f}}=\bar{\tt f}\}}$$
            we get
            $\Gamma \vdash S\ o$.
            From Lemma~\ref{weakening} and $\vdash C \subtype T[o/\self]$ 
            we get 
            $\Gamma \vdash C \subtype T[o/\self]$.
            From $\Gamma \vdash C \subtype T[o/\self]$ we get
            $\Gamma \vdash 
                S \subtype T$.
   \item
   \RCCast: For the expression {\tt e~as~T}, we have from \TCast\ that
            $\Gamma \vdash {\tt e}: {\tt U}$.
            Additionally, we have from \RCCast\ that
            ${\tt e} \derives {{\tt e}}'$.
            From the induction hypothesis, we have ${\tt U}'$ such that
            $\Gamma \vdash {\tt e}': {\tt U}'$ and
            $\Gamma \vdash U' \subtype U$.
            We now choose $S=T$.
            From $\Gamma \vdash {\tt e}': {\tt U}'$ and \TCast\ we derive
            $\Gamma \vdash {\tt e~as~T} : {\tt S}$.
            From $S=T$ and \rn{S-Id}
            we have $\Gamma \vdash S \subtype T$.
   \end{itemize}
\item
\TNew: We have a single case.
   \begin{itemize}
   \item
   \RCNewArg: For the expression ${\tt new\ C(\bar{e})}$,
            we have from \TNew\ that
            $\Gamma \vdash \bar{\tt e}: \bar{\tt T}$,
            $\theta=[\bar{\tt f}/\this.\bar{\tt f}]$,
            $\fields(C,\theta)=\bar{\tt f}: \bar{\tt Z}$,
            $\Gamma, \bar{\tt f}: \bar{\tt T} \vdash 
                    \bar{\tt T} \subtype \bar{\tt Z},$ and 
            $\sigma(\Gamma, \bar{\tt f}: \bar{\tt T}) \vdash_{\cal C} 
                    \inv({\tt C},\theta).$
            Additionally, we have from \RCNewArg\ that
            ${\tt e}_i \derives {{\tt e}}_i'$.
            From the induction hypothesis, we have ${\tt S}_i$ such that
            $\Gamma \vdash {\tt e}_i': {{\tt S}}_i$ and 
            $\Gamma \vdash S_i \subtype T_i$.

            For all $j$ except $i$, define $S_j = T_j$ and $e_j' = e_j$.
            We have 
            $\Gamma \vdash \bar{\tt e}': \bar{\tt S}$ and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$.
            From Lemma~\ref{lemmathree},
            $\Gamma, \bar{\tt f}: \bar{\tt T} \vdash
                    \bar{\tt T} \subtype \bar{\tt Z},$
            and $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash
                    \bar{\tt T} \subtype \bar{\tt Z}.$

            From Lemma~\ref{weakening} and 
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, 
            we have 
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash \bar{S} \subtype \bar{T}.$
            From \rn{S-Trans},
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash \bar{S} \subtype \bar{T},$
            and
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash
                    \bar{\tt T} \subtype \bar{\tt Z},$ we have
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash \bar{S} \subtype \bar{Z}.$
            From Lemma~\ref{lemmafour}, 
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, and
            $\sigma(\Gamma, \bar{\tt f}: \bar{\tt T}) \vdash_{\cal C}
                    \inv({\tt C},\theta),$
            we have
            $\sigma(\Gamma, \bar{\tt f}: \bar{\tt S}) \vdash_{\cal C}
                    \inv({\tt C},\theta).$

            We now choose 
              $S=C\{\bar{\tt f}: \bar{\tt S}{\tt ;\self.\bar{f}}=\bar{\tt f}\}.$
            From 
            $\Gamma \vdash \bar{\tt e}: \bar{\tt S}$,
            $\theta=[\bar{\tt f}/\this.\bar{\tt f}]$,
            $\fields(C,\theta)=\bar{\tt f}: \bar{\tt Z}$,
            $\Gamma, \bar{\tt f}: \bar{\tt S} \vdash
                    \bar{\tt S} \subtype \bar{\tt Z}$,
            $\sigma(\Gamma, \bar{\tt f}: \bar{\tt S}) \vdash_{\cal C}
                    \inv({\tt C},\theta)$, and \TNew\ we derive
            $\Gamma \vdash {\tt new\ C(\bar{e}'}: {\tt S}$.
            We have 
               $T=C\{\bar{\tt f}: \bar{T}{\tt ;\self.\bar{f}}=\bar{\tt f}\}$.

            From Lemma~\ref{lemmafive} and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma \vdash S \subtype T$.
   \end{itemize}
\item
\TField: We have two subcases.
   \begin{itemize}
   \item
   \RField:  For the expression ${\tt (\new\ C(\bar{e})).f_i}$, 
             we have from \TField\ that
             $\Gamma \vdash {\tt e}: {\tt T}_0$ and
             $\fields({\tt T}_0,{\tt z}_0) = \bar{\tt f}: \bar{\tt U}$, where
             ${\tt z}_0$ is fresh.
             Additionally, we have from \RField\ that
             $\fields(C)=\bar{f}: \bar{C}$.

             We have 
             $T_0 = C\{\bar{f}: \bar{\tt T}{\tt ;\self.\bar{f}}=\bar{\tt f}\}$
             and from \TNew, 
             $\Gamma \vdash \bar{\tt e}: \bar{\tt T}$,
             $\theta=[\bar{\tt f}/\this.\bar{\tt f}]$,
             $\fields(C,\theta)=\bar{\tt f}: \bar{\tt Z}$,
             $\Gamma, \bar{\tt f}: \bar{\tt T} \vdash 
                   \bar{\tt T} \subtype \bar{\tt Z}$, and
             $\sigma(\Gamma, \bar{\tt f}: \bar{\tt T}) \vdash_{\cal C} 
                   \inv({\tt C},\theta)$.

             From $\Gamma \vdash \bar{\tt e}: \bar{\tt T}$, we have
             $\Gamma \vdash {\tt e}_i: {\tt T}_i$.
             We now choose $S = {\tt T}_i$.
             %%%% XXX (missing step)

             Finally, it is straightforward to show
             $$\Gamma \vdash S \subtype \tt (z_0: T_0; z_0.f_i = \self; U_i).$$
   \item
   \RCField: For the expression ${\tt e.f}_i$, we have from \TField\ that
             $\Gamma \vdash {\tt e}: {\tt T}_0$ and
             $\fields({\tt T}_0,{\tt z}_0)= \bar{\tt f}\ \bar{\tt U}$
             where ${\tt z}_0$ is fresh.
             Additionally, we have from \RCField\ that  
             ${\tt e} \derives {{\tt e}}'$.
             From the induction hypothesis, we have $S_0$ such that 
             $\Gamma \vdash e': S_0$ and $\Gamma \vdash S_0 \subtype T_0$.

             We now choose 
             $S = 
               ({\tt z}_0: {\tt S}_0; {\tt z}_0.{\tt f}_i=\self;{\tt U}_i)$.
             From $\Gamma \vdash S_0\ e'$, Lemma~\ref{lemmaone}, and
             \TField, we derive
             $\Gamma \vdash S {{\tt e}}'$.

             From $\Gamma \vdash S_0 \subtype T_0$ and 
             Lemma~\ref{lemmafive}, we have $\Gamma \vdash S \subtype T$.
   \end{itemize}
\item
\TInvk: We have three subcases.
   \begin{itemize}
   \item
   \RInvk:  For the expression 
            $(\new\ {\tt C}(\bar{\tt e})).{\tt m}(\bar{\tt d})$
            we have from $\TInvk$ that
            $\Gamma \vdash \new\ {\tt C}(\bar{\tt e}): {\tt T}_0$,
            $\Gamma \vdash {\tt d}_{1:n}: {\tt T}_{1:n}$,
            $\mtype({\tt T}_0,{\tt m},{\tt z}_0) = 
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}$,
            $\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash 
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n}) \vdash_{\cal C}                          {\tt c}$, 
            where ${\tt z}_{0:n}$ is fresh, and
            $T_0 = C\{\bar{f}: \bar{A}; self.\bar{f} = \bar{f}\}$ and
            $\Gamma \vdash \bar{e}: \bar{A}$.

            For simplicity, define $d_0 = \new\ {\tt C}(\bar{\tt e})$.
            Additionally, we have from \RInvk\ that
            ${\mathit{mbody}({\tt m},{\tt C})=\bar{x}. {\tt e}_0}$.

            From Lemma~\ref{body-type}, 
            $\mtype({\tt T}_0,{\tt m},{\tt z}_0) =
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}$, and
            ${\mathit{mbody}({\tt m},{\tt C})=\bar{x}. {\tt e}_0}$,
            we have $D,V$ such that $C \subtype D$, $V \subtype U$, and
            ${\tt z}_{1:n}: \bar{\tt Z}_{1:n},\this: {\tt D} \vdash 
                  {\tt e}: {\tt V}$.

            From \rn{S-Trans} and Lemma~\ref{weakening},
            $T_0 = C\{\bar{f}: \bar{A}; \self.\bar{f} = \bar{f}\},$ 
            $\Gamma \vdash T_0 \subtype C$ and
            $C \subtype D$, 
            we have
            $\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash T_0 \subtype D$.

            From Lemma~\ref{weakening} and
            ${\tt z}_{1:n}: \bar{\tt Z}_{1:n},\this: {\tt D} \vdash 
                  {\tt e}_0: {\tt V}$, 
            we have
            $\Gamma, {\tt z}_{1:n}: \bar{\tt Z}_{1:n},\this: {\tt D} \vdash 
                  {\tt e}: {\tt V}$.

            From Lemma~\ref{substitution} and
            $$
            \begin{array}{l}
            \Gamma \vdash {\tt d}_{0:n} : {\tt T}_{0:n}, \\
            \Gamma,{\tt z}_{0:n}: {\tt T}_{0:n} \vdash T_0 \subtype D, \\
            \Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}, \mbox{and}\\
            \Gamma, {\tt z}_{1:n}: \bar{\tt Z}_{1:n},\this: {\tt D} \vdash 
                    {\tt e}_0: {\tt V}, \\
            \end{array}$$
            we have a type $S$ such that 
            $\Gamma \vdash
                 {\tt e}_0[\bar{\tt d}/{\tt z}_{0:n},\new\ C(\bar{e})/\this]: {\tt S}$ 
            and
            $\Gamma \vdash {\tt S} \subtype \bar{\tt z}_{0:n}: {\tt T}_{0:n};{\tt V}$.

   \item
   \RCInvkRecv: For the expression ${\tt e_0.m(\bar{e})}$,
            we have from \TInvk\ that
            $$
            \begin{array}{l}
            \Gamma \vdash {\tt e}_{0:n} : {\tt T}_{0:n}, \\
            \mtype({\tt T}_0,{\tt m},{\tt z}_0) = 
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}, \\
            \Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash 
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}, \mbox{and} \\
            \sigma(\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n})
                  \vdash_{\cal C} {\tt c} \\
            \end{array}$$
            where ${\tt z}_{0:n}$ is fresh.

            Additionally, from \RCInvkRecv\ we have that
            ${\tt e}_0 \derives {{\tt e}}_0'$.
            From the induction hypothesis, we have ${\tt S}_0$ such that
            $\Gamma \vdash {\tt e}_0': {{\tt S}}_0$ and 
            $\Gamma \vdash S_0 \subtype T_0$.
            For all $j>0$, define $S_j = T_j$ and $e_j' = e_j$.
            We have 
            $\Gamma \vdash \bar{\tt e}': \bar{\tt S}$ and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$.

            From Lemma~\ref{lemmatwo}
            and $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $$\mtype(S_0,m,z) = \mtype(T_0,m,z).$$

            From Lemma~\ref{lemmathree},
            $\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$,
            and $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$,

            From Lemma~\ref{lemmafour}, 
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n}) \vdash_{\cal C}
                              {\tt c}$
            we have
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n}) \vdash_{\cal C}
                              {\tt c}.$

            We now choose 
               $S=({\tt z}_{0:n}: {\tt S}_{0:n}; U)$.
            From 
            $\Gamma \vdash {\tt e}_{0:n}': {\tt S}_{0:n}$,
            $\mtype({\tt S}_0,{\tt m},{\tt z}_0) =
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}$,
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n}) \vdash_{\cal C}
                  {\tt c}$,
            and \TInvk\ we derive
            $\Gamma \vdash {\tt S}\ {\tt e_0.m(e_{1:n}')}$.
            We have 
               $T=({\tt z}_{0:n}: {\tt T}_{0:n}; {\tt U})$.

            From Lemma~\ref{lemmafive} and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma \vdash S \subtype T$.
   \item
   \RCInvkArg: For the expression ${\tt e_0.m(\bar{e})}$,
            we have from \TInvk\ that
            $\Gamma \vdash {\tt e}_{0:n} : {\tt T}_{0:n}$,
            $\mtype({\tt T}_0,{\tt m},{\tt z}_0) = 
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}$,
            $\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash 
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt Z}_{0:n}) \vdash_{\cal C}                          {\tt c}$, 
            where ${\tt z}_{0:n}$ is fresh.

            Additionally, from \RCInvkArg\ we have that, for $i>0$,
            ${\tt e}_i \derives {{\tt e}}_i'$.
            From the induction hypothesis, we have ${\tt S}_i$ such that
            $\Gamma \vdash {\tt e}_i': {{\tt S}}_i$ and 
            $\Gamma \vdash S_i \subtype T_i$.
            For all $j$ except $i$, define $S_j = T_j$ and $e_j' = e_j$.
            We have 
            $\Gamma \vdash \bar{\tt e}': \bar{\tt S}$ and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$.

            From Lemma~\ref{lemmathree},
            $\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$,
            and $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash
                  {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$,

            From Lemma~\ref{weakening} and 
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, 
            we have 
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash 
                  \bar{S} \subtype \bar{T}$.

            From \rn{S-Trans},
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash 
                  \bar{S} \subtype \bar{T}$,
            and
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash 
                    {\tt T}_{1:n} \subtype {\tt Z}_{1:n}$, 
            we have
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash 
                  \bar{S} \subtype {\tt Z}_{1:n}$.

            From Lemma~\ref{lemmafour}, 
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt T}_{0:n}) \vdash_{\cal C}
                              {\tt c}$
            we have
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n}) \vdash_{\cal C}
                              {\tt c}.$

            We now choose 
               $S=({\tt z}_{0:n}: {\tt S}_{0:n}; U)$.
            From 
            $\Gamma \vdash {\tt e}_{0:n}': {\tt S}_{0:n}$,
            $\mtype({\tt S}_0,{\tt m},{\tt z}_0) =
               \tt {\tt z}_{1:n}: {\tt Z}_{1:n}:c \rightarrow {\tt U}$,
            $\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n} \vdash
                  {\tt S}_{1:n} \subtype {\tt Z}_{1:n}$, and
            $\sigma(\Gamma, {\tt z}_{0:n}: {\tt S}_{0:n}) \vdash_{\cal C}
                  {\tt c}$,
            and \TInvk\ we derive
            $\Gamma \vdash {\tt e_0.m(e_{1:n}')}: {\tt S}$.
            We have 
               $T=({\tt z}_{0:n}: {\tt T}_{0:n}; U)$.

            From Lemma~\ref{lemmafive} and
            $\Gamma \vdash \bar{S} \subtype \bar{T}$, we have
            $\Gamma \vdash S \subtype T$.
   \end{itemize}
\end{itemize}
\end{proof}

\noindent
Let the normal form of expressions be given by {\em values}
{\tt v} {::=} $\new\ {\tt C(\bar{\tt v})}$.

\begin{theorem}[Progress] 
\label{progress}
If $\vdash {\tt e: T}$, then one of the following conditions holds:
\begin{enumerate}
\item {\tt e} is a value {\tt v}, 
\item {\tt e} contains a subexpression ${\tt \new\ C(\bar{\tt v})~as~T}$ such that
$\not\vdash {\tt C} \subtype {\tt T}[{\tt \new\ C(\bar{\tt v})}/\self]$,
\item there exists ${\tt e}'$ s.t. ${\tt e} \derives {\tt e}'$.
\end{enumerate}
\end{theorem}

\begin{proof}
The proof has a structure that is similar to the proof of Subject Reduction;
we omit the details.
\end{proof}

\begin{theorem}[Type Soundness] 
\label{type-soundness}
If $\vdash {\tt e: T}$ and ${\tt e} \starderives {\tt e}'$, with ${\tt
e}'$ in normal form, then ${\tt e}'$ is either (1)~a value {\tt v}
with $\vdash {\tt v: S}$ and $\vdash {\tt S \subtype T}$,
for some type {\tt S}, or, (2)~ an expression containing
a subexpression ${\tt \new\ {\tt C(\bar{\tt v})~as~T}}$ where 
$\not\vdash \tt C\subtype T[\new\ C(\bar{\tt v})/\self]$.

\end{theorem}

\begin{proof}
Combine Theorem~\ref{preservation} and Theorem~\ref{progress}.
\end{proof}

