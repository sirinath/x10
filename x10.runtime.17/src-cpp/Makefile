# Configurable:

CXX ?= g++
AR ?= ar

X10LIB ?= ../../pgas/common/work
X10CPP ?= ../../x10.cppbackend.17
CXXFLAGS += -g
INCLUDE_DIRS += -I$(X10LIB)/include -I.
ifdef ENABLE_GC
CXXFLAGS += -DX10_USE_BDWGC
INCLUDE_DIRS += -Ibdwgc/install/include
endif
CXXFLAGS += $(INCLUDE_DIRS)
ifeq ($(shell uname -s),AIX)
ifdef USE_XLC
CXX = mpCC_r
override CXXFLAGS -= -g
override CXXFLAGS += -q64
override CXXFLAGS += -O3 -qinline -qarch=pwr5 -qtune=pwr5 -qhot
override CXXFLAGS += -qrtti=all
else
override CXXFLAGS += -maix64
endif
# FIXME
ARFLAGS := -X64 $(ARFLAGS)
else
override CXXFLAGS += -ansi -pedantic -Wall -Wextra -Wno-long-long
ifeq ($(shell uname -s),Linux)
override CXXFLAGS += -pthread
endif
endif


#Target:

ARCHIVE = libx10rt17.a

XRX_ARCHIVE = libx10lib17.a

all: $(X10LIB)/include/x10/x10.h $(ARCHIVE) 

ALL_OBJECTS = \
	x10aux/assert.o \
	x10aux/boolean_utils.o \
	x10aux/bootstrap.o \
	x10aux/byte_utils.o \
	x10aux/char_utils.o \
	x10aux/double_utils.o \
	x10aux/int_utils.o \
	x10aux/init_dispatcher.o \
	x10aux/io/FILEPtrInputStream.o \
	x10aux/io/FILEPtrOutputStream.o \
	x10aux/io/FILEPtrStream.o \
	x10aux/float_utils.o \
	x10aux/long_utils.o \
	x10aux/math_utils.o \
	x10aux/pgas.o \
	x10aux/ref.o \
	x10aux/RTT.o \
	x10aux/rail_utils.o \
	x10aux/deserialization_dispatcher.o \
	x10aux/short_utils.o \
	x10aux/string_utils.o \
	x10aux/system_utils.o \
	x10/io/EOFException.o \
	x10/io/FileInputStream.o \
	x10/io/FileOutputStream.o \
	x10/io/FileNotFoundException.o \
	x10/io/IOException.o \
	x10/io/NativeInputStream.o \
	x10/io/NativeOutputStream.o \
	x10/lang/ArrayIndexOutOfBoundsException.o \
	x10/lang/BadPlaceException.o \
	x10/lang/ClassCastException.o \
	x10/lang/Exception.o \
	x10/lang/VoidFun_0_0.o \
	x10/lang/NullPointerException.o \
	x10/lang/Object.o \
	x10/lang/Ref.o \
	x10/lang/RuntimeException.o \
	x10/lang/String.o \
	x10/lang/Throwable.o \
	x10/lang/Value.o \
	x10/runtime/InterruptedException.o \
	x10/runtime/Lock.o \
	x10/runtime/Thread.o 


$(ARCHIVE): $(ALL_OBJECTS)
	$(AR) $(ARFLAGS) $@ $^

# Generated files:

gen/MANIFEST-x10:
	mkdir -p gen
	(cd ../src-x10 && find * -name .svn -prune -o -name \*.x10 -print) > gen/MANIFEST-x10

gen/MANIFEST: gen/MANIFEST-x10
	sed -e 's@.x10$$@.cc@' gen/MANIFEST-x10 > gen/MANIFEST

all-src-generated: gen/MANIFEST
	cd ../src-x10 && "$(X10CPP)"/bin/x10c++ -d ../src-cpp/gen -J-ea -rtdev -sourcepath . -disable CheckNativeAnnotations -commandlineonly -c `cat ../src-cpp/gen/MANIFEST-x10`

generated: all-src-generated gen/MANIFEST
	cd gen && CXXFLAGS="-I.. $(CXXFLAGS)" $(MAKE) -k $(shell sed -e 's@.cc$$@.o@' gen/MANIFEST)

$(XRX_ARCHIVE): generated
	cd gen && $(AR) $(ARFLAGS) $@ $(shell sed -e 's@.cc$$@.o@' gen/MANIFEST)
	@-cp gen/$@ .

.PRECIOUS: gen/MANIFEST

.PHONY: all-cpp-generated generated

# Standard stuff:

%.o: %.cc %.h
	$(CXX) $(CXXFLAGS) -c $< -o $@

depend:
	#print0 does not work, suspect a bug in gnu find
	find . \( -name '*.cc' -o -name '*.h' \) -print0 | xargs -r0 makedepend -Y $(INCLUDE_DIRS) -f- > depend.mk 


clean:
	find . \( -name '*.h.gch' -o -name '*.o' \) -print0 | xargs -r0 -t rm -f
	rm -f $(ARCHIVE)

squeakyclean: clean
	find . \( -name '*~' -o -name '*.bak' \) -print0 | xargs -r0 -t rm -f

.PHONY: all clean squeakyclean


#Optional file -- generated by makedepend (run "make depend").
-include depend.mk

# in this file we use hard tabs because they are semantically meaningful
# a width of 8 makes this difference more visible
# vim:tabstop=8:shiftwidth=8:noexpandtab
