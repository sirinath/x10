# Configurable:

CXX ?= g++
AR ?= ar

X10LIB ?= $(abspath ../../pgas/common/work)
CXXFLAGS += -g
INCLUDE_DIRS += -I$(X10LIB)/include -I.
ifdef ENABLE_GC
CXXFLAGS += -DX10_USE_BDWGC
BDWGC_INCLUDE_DIR= $(abspath ./bdwgc/install/include)
INCLUDE_DIRS += -I$(BDWGC_INCLUDE_DIR)
endif
CXXFLAGS += $(INCLUDE_DIRS)
ifeq ($(shell uname -s),AIX)
ifdef USE_XLC
CXX = mpCC_r
override CXXFLAGS -= -g
override CXXFLAGS += -q64
override CXXFLAGS += -O3 -qinline -qarch=pwr5 -qtune=pwr5 -qhot
override CXXFLAGS += -qrtti=all
else
override CXXFLAGS += -maix64
endif
# FIXME
ARFLAGS := -X64 $(ARFLAGS)
else
override CXXFLAGS += -ansi -pedantic -Wall -Wextra -Wno-long-long -Wno-unused-parameter -fpermissive
ifeq ($(shell uname -s),Linux)
override CXXFLAGS += -pthread
endif
endif

INSTDIR = $(abspath ../../x10.dist)


# Target:

ARCHIVE = libx10rt17.a

XRX_ARCHIVE = libx10lib17.a
XRX_MANIFEST = libx10lib17.mft

all: $(X10LIB)/include/x10/x10.h $(ARCHIVE) 

xrx: $(XRX_ARCHIVE)

ALL_OBJECTS = \
	x10aux/assert.o \
	x10aux/boolean_utils.o \
	x10aux/bootstrap.o \
	x10aux/byte_utils.o \
	x10aux/char_utils.o \
	x10aux/double_utils.o \
	x10aux/int_utils.o \
	x10aux/init_dispatcher.o \
	x10aux/io/FILEPtrInputStream.o \
	x10aux/io/FILEPtrOutputStream.o \
	x10aux/io/FILEPtrStream.o \
	x10aux/float_utils.o \
	x10aux/long_utils.o \
	x10aux/math_utils.o \
	x10aux/pgas.o \
	x10aux/ref.o \
	x10aux/RTT.o \
	x10aux/rail_utils.o \
	x10aux/deserialization_dispatcher.o \
	x10aux/short_utils.o \
	x10aux/string_utils.o \
	x10aux/system_utils.o \
	x10/io/EOFException.o \
	x10/io/FileInputStream.o \
	x10/io/FileOutputStream.o \
	x10/io/FileNotFoundException.o \
	x10/io/IOException.o \
	x10/io/NativeFile.o \
	x10/io/NativeInputStream.o \
	x10/io/NativeOutputStream.o \
	x10/lang/ArrayIndexOutOfBoundsException.o \
	x10/lang/BadPlaceException.o \
	x10/lang/ClassCastException.o \
	x10/lang/Exception.o \
	x10/lang/VoidFun_0_0.o \
	x10/lang/NullPointerException.o \
	x10/lang/Object.o \
	x10/lang/Ref.o \
	x10/lang/RuntimeException.o \
	x10/lang/String.o \
	x10/lang/Throwable.o \
	x10/lang/Value.o \
	x10/runtime/InterruptedException.o \
	x10/runtime/Lock.o \
	x10/runtime/Thread.o 


$(ARCHIVE): $(ALL_OBJECTS)
	$(AR) $(ARFLAGS) $@ $^

# Generated files:

gen/MANIFEST-x10:
	mkdir -p gen
	(cd ../src-x10 && find * -name .svn -prune -o -name \*.x10 -print) > gen/MANIFEST-x10

gen/MANIFEST: all-src-generated
	(cd gen && find * -name \*.cc -print) | grep -f DEPENDENCIES.txt -v > gen/MANIFEST.raw
	cat DEPENDENCIES.txt gen/MANIFEST.raw > gen/MANIFEST
	rm gen/MANIFEST.raw

all-src-generated: gen/MANIFEST-x10
	cd ../src-x10 && "$(INSTDIR)"/bin/x10c++ -d ../src-cpp/gen -J-ea -rtdev -sourcepath . -disable CheckNativeAnnotations -commandlineonly -c $(shell cat ../src-cpp/gen/MANIFEST-x10)

generated: all-src-generated gen/MANIFEST
	cd gen && CXXFLAGS="-I.. $(CXXFLAGS)" $(MAKE) -k $(shell sed -e 's@.cc$$@.o@' gen/MANIFEST)

$(XRX_MANIFEST): gen/MANIFEST
	@-cp $^ $@

$(XRX_ARCHIVE): generated $(XRX_MANIFEST)
	cd gen && $(AR) $(ARFLAGS) $@ $(shell sed -e 's@.cc$$@.o@' gen/MANIFEST)
	@-cp gen/$@ .

.PRECIOUS: gen/MANIFEST

.PHONY: all-cpp-generated generated


# Install targets:

# FIXME: remove the part of the rule that copies the .inc files as soon as we get rid of them..
install: $(ARCHIVE) $(XRX_ARCHIVE)
	mkdir -p $(INSTDIR)/include $(INSTDIR)/lib
	(cd gen && find . -name \*.h | tar -T - -cf -) | tar -C $(INSTDIR)/include -xvf -
	(cd gen && find . -name \*.inc | tar -T - -cf -) | tar -C $(INSTDIR)/include -xvf -
	find x10 -name \*.h | tar -T - -cf - | tar -C $(INSTDIR)/include -xvf -
	find x10aux -name \*.h | tar -T - -cf - | tar -C $(INSTDIR)/include -xvf -
	cp -p x10rt17.h $(INSTDIR)/include
	cp -p $(ARCHIVE) $(INSTDIR)/lib
	cp -p $(XRX_ARCHIVE) $(INSTDIR)/lib
	cp -p $(XRX_MANIFEST) $(INSTDIR)/lib

.PHONY: install


# Standard stuff:

%.o: %.cc %.h
	$(CXX) $(CXXFLAGS) -c $< -o $@

depend:
	find . -name gen -prune -o \( -name '*.cc' -o -name '*.h' \) -print0 | xargs -r0 makedepend -Y $(INCLUDE_DIRS) -I/usr/include -f- > depend.mk 
	echo './gen/MANIFEST-x10: $(shell find ../src-x10 -name .svn -prune -o -name \*.x10 -print)' >> depend.mk


clean:
	find . -name gen -prune -o \( -name '*.h.gch' -o -name '*.o' \) -print0 | xargs -r0 -t rm -f
	rm -f $(ARCHIVE)

squeakyclean: clean
	find . \( -name '*~' -o -name '*.bak' \) -print0 | xargs -r0 -t rm -f
	rm -rf gen
	rm -f $(XRX_ARCHIVE)

.PHONY: all clean squeakyclean


# Optional file -- generated by makedepend (run "make depend").
-include depend.mk

# in this file we use hard tabs because they are semantically meaningful
# a width of 8 makes this difference more visible
# vim:tabstop=8:shiftwidth=8:noexpandtab
