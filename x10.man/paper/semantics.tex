
\newcommand{\starderives}{\derives^*}
\def\from#1\infer#2{{{\textstyle #1}\over{\textstyle #2}}}
\def\axname#1\axiom#2{{\textstyle #2}{\ \textstyle(\mbox{#1)}}}
\def\rname#1\from#2\infer#3{{{\textstyle #2}\over{\textstyle #3}}{\ \textstyle(\mbox{#1)}}}
\def\derives{\longrightarrow}
\def\subtype{\sqsubseteq}

\def\super{\mbox{\tt super}}
\def\class{\mbox{\tt class}}
\def\extends{\mbox{\tt extends}}
\def\return{\mbox{\tt return}}
\def\new{\mbox{\tt new}}
\def\this{\mbox{\tt this}}
\def\self{\mbox{\tt self}}
\def\true{\mbox{\tt true}}
\def\inv{\mbox{\em inv}}

\begin{figure*}

\paragraph{Syntax.} 
The syntax for the language is specified as follows. 

We assume a fixed constraint system, $\cal C$, with inference relation
$\vdash_{\cal C}$. All constraint systems are required to support the
trivial constraint \true, conjunction, existential quantification and
equality on constraint terms. Constraint terms include (final)
variables, the special variable {\tt self} (which may occur only in
constraints {\tt c} which occur in a constrained type {\tt C(:c)}),
and field selections {\tt t.f}. Finally, we assume that constraints
are closed under variable substitution. We denote the application of
the substitution $[\bar{t}/\bar{x}]$ to a constraint $c$ by
$c[\bar{t}/\bar{x}]$.

\begin{tabular}{rrcl}
&&&\\
(Class) & L &{::=}& $\tt\class \ C(\bar{T}\ \bar{f}:c)\  \extends\ T\ \{\bar{M}\}$ \\
(Method)& M &{::=}& $\tt T\ m(\bar{T}\ \bar{x}:c)\{\return\ e;\}$\\
(Expr)& e &{::=}& $\tt x \alt e.f \alt e.m(\bar{e})\alt \new\ C(\bar{e})\alt (T)e$\\\quad\\
(C Terms) & t&{::=}& \tt x\alt \self \alt \this \alt t.f\\
(Constraint) & c,d&{::=}&$\tt \true\alt a\alt t=t\alt c,c\alt T\,x;c$\\
(Type)& S,T,U&{::=}& $\tt C(:d)$\\
&&&\\
\end{tabular}

\paragraph{Subtyping Judgements.}
We let $\Gamma$ stand for multisets of type assertions, of the form
$T\,x$, and constraints. We define $\sigma(\Gamma)$ to be the set of
constraints obtained from $\Gamma$ by replacing each type assertion
${\tt C(:d)\ x}$ with ${\tt d}[{\tt x}/\self]$. 

$$
\begin{array}{ll}
\Gamma\vdash {\tt T} \subtype {\tt T}
&
\from{\class\ {\tt C(\ldots)}\ \extends\ {\tt D(\ldots)}\{\ldots\}}
\infer{\vdash {\tt C \subtype D}}
\\ & \\
\from{\Gamma \vdash {\tt C \subtype D} \ \ \ \sigma(\Gamma),{\tt c} \vdash_{\cal C} {\tt d}}
\infer{\Gamma \vdash {\tt C(:c) \subtype D(:d)}}
&
\from{\Gamma \vdash {\tt S \subtype T} \ \ \ \Gamma \vdash {\tt T \subtype U}}
\infer{\Gamma \vdash {\tt S \subtype U}}
\end{array}
$$

\paragraph{Type Judgements.}

Let {\tt C} be a class declared as ${\tt \class\ C(\bar{\tt T}\ \bar{\tt f}:c)\ extends\ D(:d)\{\bar{\tt M}\}}$. We let
$\inv({\tt C})$ stand for the conjunction {\tt c,d} and (recursively)
$\inv({\tt D})$. We bottom out with $\inv({\tt Object})=\true$. 
$$
\begin{array}{ll}
\axname{T-Var}
\axiom{\Gamma, {\tt T}\ {\tt x} \vdash {\tt T}\ {\tt x}} \\ & \\
\rname{T-Inv}
\from{\Gamma \vdash {\tt C(:c)\ x} \ \ \ \ {\tt d}=inv (C)}
\infer{\Gamma \vdash {\tt C(:c,d[\self/\this])\ x}}  &  
\rname{T-Constr}
\from{\Gamma \vdash {\tt C(:c)\ x} \ \ \ \sigma(\Gamma), {\tt c}[{\tt x}/\self] \vdash_{\cal C}{\tt d[x/\self]}}
\infer{\Gamma \vdash {\tt C(:d)\ x}} 
\\ \quad \\
\rname{T-Field}
\from{\Gamma \vdash {\tt T}_0\ {\tt e} \ \ \ fields({\tt T}_0)= \bar{\tt U}(:\bar{\tt d}) \bar{\tt f} \ \ \ \mbox{({\tt o} fresh for $\Gamma,{\tt d}_i$)}}
\infer{\Gamma \vdash {\tt U}_i(:{\tt T}_0\ {\tt o;o.f}=\self,{\tt d}_i)\, {\tt e.f}_i} 
& 
\axname{T-Cast}
\axiom{\Gamma \vdash {\tt T\ (T) e}} \\
& \\
\rname{T-Invk}
\from{\begin{array}{l}
\Gamma \vdash {\tt T}_0 \ {\tt e}_0, \bar{\tt T}\ \bar{\tt e} \ \ \ \ 
mtype({\tt T}_0,m)= \tt \bar{\tt Z}\ \bar{\tt z},c \rightarrow {\tt S(:d)} \\
\Gamma, {\tt T}_0\ \tt o, \bar{\tt T} \ \bar{\tt z} \vdash c[o/\this], \bar{\tt T} \subtype \bar{\tt Z}[o/\this] \ \ \mbox {({\tt o} fresh for $\Gamma,
{\tt c},{\tt d}$)}
\end{array}}
\infer{\Gamma \vdash {\tt S(:T}_0\ {\tt o;\bar{\tt T}\ \bar{\tt z}; d[o/\this])}\ {\tt e}_0.{\tt m(\bar{\tt e})}}&
\rname{T-New}
\from{
  \begin{array}{l}
    \Gamma \vdash \bar{\tt T}\ \bar{\tt e} \ \ \  
    fields(C)=\bar{\tt Z}\ \bar{f} \ \ \ {\tt c}=\inv(C) \\
    \Gamma, \bar{\tt T}\ \bar{\tt f} 
      \vdash {\tt c}[\bar{\tt f}/\this.\bar{\tt f}],\bar{\tt T} \subtype \bar{\tt Z}[\bar{\tt f}/\this.\bar{\tt f}]
  \end{array}
}
\infer{\Gamma \vdash {\tt C(:\bar{T}\ \bar{\tt f}{\tt ;\self.\bar{f}}=\bar{\tt f})\ \new\ {\tt C(\bar{\tt e})}}} \\
\end{array}
$$
\paragraph{Method and Class Typing.}
$$
\begin{array}{ll}
\from{ \bar{\tt T}\ \bar{\tt x}, {\tt C}\ \this, {\tt c} \vdash {\tt S}\ {\tt e}, {\tt S} \subtype {\tt T} }   
\infer{\tt T\ m(\bar{\tt T}\,\bar{\tt x} : c)\{\return\ e;\}\ \mbox{OK in}\ C} &
\from{\bar{M}\ \mbox{OK in}\ C}
\infer{\tt \class\ C(\bar{\tt T}\ \bar{\tt f}:c)\ \extends\ D(:d)\ \{\bar{M}\}\ \mbox{OK}} 
\end{array}
$$

\caption{Constrained FJ}\label{FJ-Table}
\end{figure*}

\begin{figure*}
\paragraph{Computation:}

$$
\begin{array}{c}
\rname{{\sc R-FIELD}}
\from{fields(C)=\bar{C}\ \bar{f}}
\infer{(\new\ {\tt C}(\bar{\tt e})).{\tt f}_i \derives {\tt e}_i} \\ \quad\\
\rname{{\sc R-INVK}}
\from{mbody({\tt m},{\tt C})=\bar{x}. \bar{e}_0}
\infer{(\new\ {\tt C}(\bar{\tt e})).{\tt m}(\bar{\tt d}) \derives 
[\bar{d}/\bar{x},\new\ C(\bar{e})/\this]{\tt e}_0} \\ \quad\\
\rname{{\sc R-CAST}}
\from{\vdash C \subtype D[\new\ C(\bar{\tt d})/\self]}
\infer{{\tt (D)(\new\ C(\bar{\tt d}))} \derives \new\ C(\bar{\tt d})}
\end{array}
$$
\paragraph{Congruence:}
$$
\begin{array}{c}
\rname{{\sc RC-FIELD}}
\from{{\tt e}_0 \derives {{\tt e}_0}'}
\infer{{\tt e}_0.{\tt f} \derives {{\tt e}_0}'.{\tt f}} \\ \quad\\
\rname{{\sc RC-INVK-RECV}}
\from{{\tt e}_0 \derives {{\tt e}_0}'}
\infer{{\tt e}.{\tt m}(\bar{\tt e}) \derives {{\tt e}_0}'.{\tt m}(\bar{\tt e})} \\ \quad\\
\rname{{\sc RC-INVK-ARG}}
\from{{\tt e}_i \derives {{\tt e}_i}'}
\infer{{\tt e}.{\tt m}(\ldots,{\tt e}_i,\ldots) \derives {{\tt e}_0}.{\tt m}(\ldots,{\tt e}_i',\ldots)}\\ \quad\\
\rname{{\sc RC-NEW-ARG}}
\from{{\tt e}_i \derives {{\tt e}_i}'}
\infer{\new\ {\tt C}(\ldots,{\tt e}_i,\ldots) \derives \new\ {\tt C}(\ldots,{\tt e}_i',\ldots)} \\ \quad\\
\rname{{\sc RC-CAST}}
\from{{\tt e}_0 \derives {{\tt e}_0}'}
\infer{{\tt (C) e}_0 \derives {{\tt (C) e}_0}'}
\end{array}
$$

\caption{Reduction rules for Constrained FJ}\label{CFJ-red-rules}
\end{figure*}

\begin{theorem}[Subject Reduction] 

If $\Gamma \vdash T\ e$ and $e \derives e'$, then for some type $S$,
$\Gamma \vdash S\ e'$ and $\Gamma \vdash S \subtype T$.

\end{theorem}

Let the normal form of expressions be given by {\em values},
i.e. expressions 

\begin{tabular}{rrcl}
&&&\\
(Values) & {\tt v} &{::=}& $\new\ {\tt C(\bar{\tt v})}$
\end{tabular}


\begin{theorem}[Type Soundness] 

If $\vdash T\ e$ and $e \starderives e'$, then $e'$ is
either (1)~a value {\tt } with $\vdash {\tt S\ v}$ and $\vdash {\tt S
\subtype T}$, for some type {\tt S}, or, (2)~ an expression containing
a subexpression ${\tt (T)\new\ C(\bar{\tt v})}$ where 
$\not\vdash \tt C\subtype T[\new\ C(\bar{\tt v})/\self]$.

\end{theorem}

